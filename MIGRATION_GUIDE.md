# 프로그램 계층 구조 마이그레이션 가이드

## 개요
수영 프로그램을 계층 구조로 재구성하여 커리큘럼 체계를 명확하게 표현합니다.

## 새로운 프로그램 구조

### 메인 프로그램
1. **기초반** (신규)
2. **초급반** (기존 데이터 업데이트)
3. **중급반** (기존 데이터 업데이트)
4. **상급** (기존 "고급 수영 교실"을 변경)
   - 상급1 (하위 프로그램)
   - 상급2 (하위 프로그램)
   - 상급3 (하위 프로그램)
5. **고급** (신규)
   - 연수1 (하위 프로그램)
   - 연수2 (하위 프로그램)
6. **마스터** (신규)

### 삭제된 프로그램
- 아쿠아로빅 (삭제)
- 어린이 수영교실 (삭제)
- 개인 레슨 (삭제)

## 마이그레이션 단계

### 1단계: 데이터베이스 스키마 업데이트

Supabase 대시보드의 SQL 에디터에서 다음 파일을 실행하세요:

```
migrations/001_add_program_hierarchy.sql
```

이 마이그레이션은 다음을 추가합니다:
- `parent_id`: 상위 프로그램 참조
- `curriculum_content`: 수업 내용
- `requirements`: 수강 조건
- `display_order`: 표시 순서

### 2단계: 기존 데이터 업데이트

Supabase 대시보드의 SQL 에디터에서 다음 파일을 실행하세요:

```
migrations/002_update_program_curriculum.sql
```

이 마이그레이션은:
- 기존 프로그램 업데이트
- 신규 프로그램 생성
- 계층 구조 설정
- 표시 순서 재정렬
- **멱등성**: 여러 번 실행해도 안전하도록 개선됨

### 3단계: 중복 데이터 정리 (필요시)

**⚠️ 중요**: 마이그레이션 002를 여러 번 실행한 경우에만 필요합니다.

데이터베이스에 중복 프로그램이 있는지 확인:

```sql
SELECT title, level, COUNT(*) as count
FROM programs
GROUP BY title, level
HAVING COUNT(*) > 1;
```

중복이 있다면 다음 정리 스크립트를 실행하세요:

```
migrations/003_cleanup_duplicates.sql
```

이 마이그레이션은:
- 모든 중복 프로그램 제거
- 올바른 parent_id 관계 재설정
- 각 프로그램이 정확히 1개씩만 존재하도록 보장

### 4단계: 애플리케이션 재배포

코드 변경사항이 프로덕션에 반영되도록 애플리케이션을 재배포하세요.

## 주요 변경사항

### 데이터베이스
- `programs` 테이블에 4개의 새 컬럼 추가
- 계층 구조를 위한 인덱스 추가

### 백엔드
- `getProgramsWithHierarchy()` 함수 추가
- 프로그램 조회 시 `display_order`로 정렬

### 관리자 페이지
- 상위 프로그램 선택 드롭다운
- 수업 내용 및 수강 조건 입력 필드
- 표시 순서 설정
- 계층 구조 시각화 (들여쓰기)

### 프론트엔드
- 프로그램 카드에 수업 내용 표시
- 수강 조건 배지 표시
- 하위 레벨 배지 표시

## 주의사항

1. **마이그레이션 순서**: 반드시 001번을 먼저 실행한 후 002번을 실행하세요.
2. **백업**: 마이그레이션 전에 데이터베이스 백업을 권장합니다.
3. **롤백**: 문제 발생 시 Supabase 대시보드에서 테이블을 복원할 수 있습니다.

## 추가 작업

마이그레이션 후 다음 작업을 수행하세요:

1. 관리자 페이지에서 각 프로그램의 가격, 일정, 강사 정보 확인 및 수정
2. 프로그램 이미지 업로드 (필요한 경우)
3. 프론트엔드에서 표시 확인

## 문제 해결

### 마이그레이션 실패 시
1. Supabase 대시보드의 Logs 확인
2. 에러 메시지 확인
3. 필요시 마이그레이션 스크립트 수정 후 재실행

### 데이터 불일치 시
```sql
-- 모든 프로그램 확인
SELECT id, title, level, parent_id, display_order
FROM programs
ORDER BY display_order;

-- 하위 프로그램이 있는 메인 프로그램 확인
SELECT p.title as parent, c.title as child
FROM programs p
JOIN programs c ON c.parent_id = p.id
ORDER BY p.display_order, c.display_order;
```

## 지원

문제가 발생하면 다음을 확인하세요:
- Supabase 대시보드의 Logs
- 브라우저 콘솔
- 네트워크 요청
